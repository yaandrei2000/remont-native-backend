// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  phone        String   @unique
  firstName    String?
  lastName     String?
  email        String?
  points       Int      @default(0)
  role         UserRole @default(CLIENT)
  // Поля для мастеров
  rating       Float?   @default(0)
  reviewsCount Int?     @default(0)
  isActive     Boolean? @default(true)
  cityId       String?
  city         City?    @relation(fields: [cityId], references: [id], onDelete: SetNull)
  // Push notification token
  pushToken    String?
  // Реферальный код пользователя
  referralCode String?  @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ordersAsClient        Order[]              @relation("ClientOrders")
  ordersAsMaster        Order[]              @relation("MasterOrders")
  referrals             Referral[]            @relation("Referrer")
  referred              Referral?             @relation("Referred")
  masterApplication     MasterApplication?
  processedApplications MasterApplication[]  @relation("ProcessedApplications")
  promoCodeUsages       PromoCodeUsage[]

  @@index([role])
  @@index([referralCode])
  @@map("users")
}

enum UserRole {
  CLIENT
  MASTER
  ADMIN
}

model City {
  id        String   @id @default(cuid())
  name      String   @unique
  region    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users    User[]
  services ServiceCity[] // Связь с услугами через промежуточную таблицу

  @@index([name])
  @@map("cities")
}

model AuthCode {
  id        String   @id @default(cuid())
  phone     String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone, code])
  @@map("auth_codes")
}

model ServiceCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  image       String?  // Ссылка на изображение категории
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  services Service[]

  @@map("service_categories")
}

model Service {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  price       Float?
  image       String?  // Ссылка на изображение услуги
  time        String?  // Время выполнения работы (например, "1-2 часа", "1 день")
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orders    OrderItem[]
  cities    ServiceCity[] // Связь с городами через промежуточную таблицу

  @@unique([categoryId, slug])
  @@map("services")
}

// Промежуточная таблица для связи услуг с городами (many-to-many)
model ServiceCity {
  id        String   @id @default(cuid())
  serviceId String
  cityId    String
  createdAt DateTime @default(now())

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  city    City    @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@unique([serviceId, cityId]) // Одна услуга может быть в городе только один раз
  @@index([cityId])
  @@index([serviceId])
  @@map("service_cities")
}

model Order {
  id              String       @id @default(cuid())
  orderNumber     String       @unique
  clientId        String?
  masterId        String?
  status          OrderStatus  @default(PENDING)
  recipient       String       @default("me")
  clientName      String
  clientPhone     String
  city            String
  address         String
  apartment       String?
  isPrivateHouse  Boolean      @default(false)
  urgency         OrderUrgency @default(URGENT)
  scheduledDate   DateTime?
  scheduledTime   String?
  totalPrice      Float?
  workDescription String?
  warranty        String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  completedAt     DateTime?

  client User?       @relation("ClientOrders", fields: [clientId], references: [id], onDelete: SetNull)
  master User?       @relation("MasterOrders", fields: [masterId], references: [id], onDelete: SetNull)
  items  OrderItem[]
  steps  OrderStep[]

  @@index([clientId])
  @@index([masterId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  serviceId String
  quantity  Int      @default(1)
  price     Float
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model OrderStep {
  id          String     @id @default(cuid())
  orderId     String
  title       String
  description String?
  status      StepStatus @default(PENDING)
  completedAt DateTime?
  createdAt   DateTime   @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_steps")
}

model Referral {
  id         String         @id @default(cuid())
  referrerId String
  referredId String         @unique
  points     Int            @default(0)
  status     ReferralStatus @default(PENDING)
  completedAt DateTime?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  referrer User @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referred User @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([status])
  @@map("referrals")
}

enum ReferralStatus {
  PENDING
  COMPLETED
}

model PromoCode {
  id           String    @id @default(cuid())
  code         String    @unique
  description  String?   // Описание промокода
  points       Int       @default(0) // Количество баллов за активацию
  discount     Float?    // Скидка (если используется)
  discountType String?   // "percentage" | "fixed"
  minAmount    Float?
  maxDiscount  Float?
  expiresAt    DateTime?
  usageLimit   Int?
  usedCount    Int       @default(0)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  usages PromoCodeUsage[]

  @@index([isActive])
  @@map("promo_codes")
}

model PromoCodeUsage {
  id         String   @id @default(cuid())
  promoCodeId String
  userId     String
  points     Int      @default(0) // Баллы, полученные за активацию
  createdAt  DateTime @default(now())

  promoCode PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([promoCodeId, userId]) // Пользователь может использовать промокод только один раз
  @@index([userId])
  @@index([promoCodeId])
  @@map("promo_code_usages")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum OrderUrgency {
  URGENT
  SCHEDULED
}

enum StepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

model MasterApplication {
  id             String                    @id @default(cuid())
  userId         String                    @unique
  name           String
  phone          String
  email          String?
  experience     String?                   // Опыт работы (лет)
  specialties    String[]                  // Специализации (массив строк)
  description    String?                   // Описание о себе
  status         MasterApplicationStatus   @default(PENDING)
  processedAt    DateTime?
  processedById  String?                   // ID админа, который обработал заявку
  processedBy    User?                     @relation("ProcessedApplications", fields: [processedById], references: [id], onDelete: SetNull)
  rejectionReason String?                  // Причина отклонения
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
  @@map("master_applications")
}

enum MasterApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}
